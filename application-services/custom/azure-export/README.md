# Azure Export Service #

#### Overview ####

Many IoT deployments require some form of integration with the cloud. The integration will be required for both north- and south-bound services. For north-bound services, data is exported from the device to the cloud for analytics or further processing. This document demonstrates a sample EdgeX application service – the Azure Export Service – that consumes the device data and exports the readings to the Azure IoT Hub.  The entire technical architecture is illustrated below:

![Technical Architecture](./Northbound.png)

#### Prerequisites ####

* Obtain the code from the https://github.com/edgexfoundry/edgex-examples/application-services/custom/azure-export 
* Ensure that EdgeX is running with mandatory services, including core services and logging service
* Ensure that the Virtual Device Service is running and managed by EdgeX with at least one pre-defined device, such as Random-Boolean-Device<br>

If you are unfamiliar with the Azure IoT Hub, read the following documents first, as this document intentionally omits some details on Azure:
* [Create an Azure IoT Hub on the Azure portal](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-create-through-portal)
* [Set up X.509 security on Azure IoT Hub](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-security-x509-get-started)

#### Steps ####

1. In the code obtained from the https://github.com/edgexfoundry/edgex-example repo, update the [application-services/custom/azure-export/res/configuration.toml](./res/configuration.toml) with the following values:<br>
    ```
     [ApplicationSettings]
     IoTHub         = "EdgeX"
     IoTDevice      = "MyDevice"
     MQTTCert       = "/secret/rsa_cert.pem"
     MQTTKey        = "/secret/rsa_private.pem"
     TokenPath      = "/secret/secrets-token.json"
     VaultHost      = "localhost"
     VaultPort      = "8200"
     CertPath       = "v1/secret/edgex/edgex-application-service/iothub"
     DeviceNames    = "Random-Integer-Device"
    ```
   Where:
   - `IoTHub` is the name of your Azure IoT hub, which can be found in the Azure Portal. 
   - `IoTDevice` is the ID of your IoT device created on the Azure IoT Hub, which can be found in the Azure Portal.  **Note:** The thumbprint of this device must be associated with the cert/key specified in `MQTTCert`/`MQTTKey` or `CertPath`.
   - `DeviceNames` are the devices managed by EdgeX in a comma-separated list if specifying multiple devices.  To simplify the process, this sample service only uses the [Random-Integer-Device as pre-defined in virtual device](https://github.com/edgexfoundry/device-virtual-go).
   - `MQTTCert` is the location of the certificate used to register with the Azure IoT Hub. This location must be accessible to your Azure Export Service. 
   - `MQTTKey`  is the location of the private key used to register with the Azure IoT Hub. This location must be accessible to your Azure Export Service.
   - `VaultHost` is the host of the vault secret store.
   - `VaultPort` is the port number of the vault secret store.
   - `CertPath` is the path to the certificate in the vault secret store.
   - `TokenPath` is the vault token file used to access the [vault secret store integrated with EdgeX](https://docs.edgexfoundry.org/1.3/microservices/security/Ch-SecretStore/).  This location must be accessible to your Azure Export Service. To simplify the process, use the client token file as generated by vault-worker for application service at following location:<br>
     
     ```
     /tmp/edgex/secrets/edgex-application-service/secrets-token.json
     ```
   
2. As the Azure IoT Hub requires secured communication using MQTT over TLS, we need a key/certificate pair to connect to the cloud, and as mentioned in the Prerequisites, you need the X.509 certificate and private key. The Azure Export Service provides two methods to configure the key/cert pair. By default, the service tries to retrieve the pair from vault:
   * Ensure that the `VaultHost` and `VaultPort` values point to the vault in your environment
   * Copy /tmp/edgex/secrets/edgex-application-service/secrets-token.json to the location accessible to your azure-export service
   * Create the cert and key properties as secret at `CertPath` in vault. You can do this through either Vault's web GUI at https://localhost:8200/ui/vault or Vault's REST API. To login to the GUI or use REST API, you must obtain the value of "client_token" from the file pointed to by `TokenPath` in vault, for example:<br>
     ```
     {
         "auth": {
            "accessor": "55IZQE2jX0OPYJR9tYe6nQx0",
            "client_token": "s.LyzyfYXNiy78XPoINVp0q8zf",
            "entity_id": "",
            "lease_duration": 3600,
            "metadata": {
               "edgex-service-name": "edgex-application-service"
            },
            "orphan": true,
            "policies": [
            "default",
            "edgex-service-edgex-application-service"
            ],
            "renewable": true,
            "token_policies": [
            "default",
            "edgex-service-edgex-application-service"
            ],
            "token_type": "service"
         },
         "data": null,
         "lease_duration": 0,
         "lease_id": "",
         "renewable": false,
         "request_id": "782e6f13-4017-105e-4ed8-5cd7b3d57a70",
         "warnings": null,
         "wrap_info": null
      }
     ```
      * Through Vault's web GUI, under **secrets**, navigate to **edgex/edgex-application-service** and create a secret called **iothub**
      * Through Vault's web GUI, create two key/value pairs, **cert** and **key**, under **edgex/edgex-application-service/iothub**.  The values for **cert** and **key** are the actual key and certificate in pem format, and must be the key/cert that you previously configured in the Azure IoT Hub. This example uses the default secret path defined in `CertPath`, you can create a different secret and change `CertPath` accordingly. If configured properly, the Azure Export Service can retrieve the key/cert pair and establish a connection to the Azure IoT Hub. If the service fails to retrieve the key/cert from vault, it will fall back to use key/cert files from the local file system configured in `MQTTCert` and `MQTTKey`. At this point, the Azure IoT hub is configured.
      * Through Vault's REST API, using following command to create two key/value pairs, **cert** and **key**, under **edgex/edgex-application-service/iothub**.
        ```
        curl -k -X POST \
        -H "X-Vault-Token:s.LyzyfYXNiy78XPoINVp0q8zf" \
        --data '{"cert":"-----BEGIN CERTIFICATE-----\nMIIAJBgNVBAYTAlRXMRMwEQYDVQQIDApT\n-----END CERTIFICATE-----\n","key":"-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDBW5VXLmNugcKA\n-----END PRIVATE KEY-----\n"}' \
        https://localhost:8200/v1/secret/edgex/edgex-application-service/iothub 
        ```
   
3. Build the Azure Export service

    ```
    make build
    ```

4. Run the Azure Export service and the Azure Export Service is exporting readings to the Azure IoT Hub at this point

    ```
    ./app-service
    ```

5. To see if your Azure IoT Hub receives the exported readings from EdgeX, use the **Azure IoT Tools** extension in Visual Studio Code to monitor messages from the device as follows:
   * Download and Install [Visual Studio Code](https://code.visualstudio.com/)
   * Launch Visual Studio Code
   * Install the Azure IoT Tools extension
   * Press **Ctrl** + **Shift** + **P**  to open the Command Palette
   * Enter **Azure: Select Subscriptions**
   * Select your **subscription** > **IoT Hub**, Devices display in the Azure IOT HUB tab on the left side.
   * Right-click **Device ID**
   * Select **Start Monitoring Built-in Event Endpoint**. The incoming event is displayed in the Output tab